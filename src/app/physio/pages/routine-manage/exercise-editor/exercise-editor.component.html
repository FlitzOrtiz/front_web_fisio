<div class="exercise-editor">
  <div class="editor-header">
    <h2>{{ exercise ? "Editar Ejercicio" : "Añadir Ejercicio" }}</h2>
    <fbutton
      label=""
      size="sm"
      [isSquare]="true"
      [isTransparent]="true"
      s
      icon="fa-solid fa-xmark"
      (onClick)="onCancel()"
    ></fbutton>
  </div>

  <form [formGroup]="exerciseForm" (ngSubmit)="onSubmit()">
    <div class="form-group">
      <label for="name">Nombre de la Rutina</label>
      <input
        type="text"
        id="name"
        formControlName="name"
        class="form-control"
        placeholder="Ej: Rehabilitación Lumbar Básica"
      />
      <div
        *ngIf="
          exerciseForm.get('name')?.invalid && exerciseForm.get('name')?.touched
        "
        class="error-message"
      >
        El nombre del ejercicio es obligatorio
      </div>
    </div>

    <div class="tabs">
      <div class="tab-header">
        <button
          type="button"
          class="tab-btn"
          [class.active]="activeTab === 'youtube'"
          (click)="setActiveTab('youtube')"
        >
          Youtube
        </button>
        <button
          type="button"
          class="tab-btn"
          [class.active]="activeTab === 'library'"
          (click)="setActiveTab('library')"
        >
          Biblioteca
        </button>
      </div>

      <div class="tab-content">
        <div *ngIf="activeTab === 'youtube'" class="youtube-tab">
          <div class="form-group">
            <input
              type="text"
              formControlName="videoUrl"
              class="form-control"
              placeholder="Ej: https://www.youtube.com/watch?v=dQw4w9WgXcQ"
              (input)="onVideoUrlChange()"
            />
          </div>

          <div class="selected-video-preview">
            <label>Video seleccionado:</label>
            <div
              class="youtube-embed-container"
              style="
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
              "
            >
              <ng-container *ngIf="videoId; else noVideo">
                <div
                  id="youtube-player"
                  style="
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
                  "
                ></div>
                <fbutton
                  label="Añadir momento clave"
                  size="md"
                  icon="fa-solid fa-clock"
                  (onClick)="addKeyMomentFromVideo()"
                  class="add-keymoment-btn"
                  style="margin-top: 1rem"
                ></fbutton>
                <div class="key-moments-list" formArrayName="keyMoments">
                  <div
                    *ngFor="
                      let moment of keyMomentsArray.controls;
                      let i = index
                    "
                    [formGroupName]="i"
                    class="key-moment-item-row"
                  >
                    <div class="key-moment-item">
                      <div class="time-input">
                        <i class="fa-regular fa-clock"></i>
                        <span>{{ formatSeconds(moment.value.time) }}</span>
                      </div>
                      <input
                        type="text"
                        formControlName="description"
                        class="form-control description-input"
                        placeholder="Descripción del momento clave"
                      />
                      <fbutton
                        label=""
                        size="sm"
                        icon="fa-solid fa-trash"
                        (onClick)="removeKeyMoment(i)"
                        class="remove-btn"
                      ></fbutton>
                    </div>
                  </div>
                </div>
              </ng-container>
              <ng-template #noVideo>
                <div
                  class="video-placeholder"
                  style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 200px;
                  "
                >
                  <i class="fa-solid fa-video fa-4x" style="color: #bbb"></i>
                  <div
                    class="video-message"
                    style="margin-top: 1rem; color: #888"
                  >
                    <span *ngIf="exerciseForm.value.videoUrl && !videoId">
                      No se pudo encontrar el video de YouTube. Verifica la URL.
                    </span>
                    <span *ngIf="!exerciseForm.value.videoUrl">
                      Coloca una URL de YouTube para mostrar el video aquí.
                    </span>
                  </div>
                </div>
              </ng-template>
            </div>
          </div>
        </div>

        <div *ngIf="activeTab === 'library'" class="library-tab">
          <div class="refresh-btn-container">
            <fbutton
              label=""
              size="sm"
              icon="fa-solid fa-rotate"
              (onClick)="refreshVideos()"
              [isTransparent]="true"
              class="refresh-btn"
            ></fbutton>
          </div>
          <ul class="video-list">
            <li *ngFor="let video of allVideos" class="video-list-item">
              <div class="video-thumb">
                <video [src]="video.url" controls width="120"></video>
              </div>
              <div class="video-meta">
                <span class="video-name">{{
                  video.name || video.title || "Sin nombre"
                }}</span>
                <span class="video-duration">{{
                  video.duration ? video.duration + " min" : ""
                }}</span>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col">
        <label for="series">Series</label>
        <input
          type="number"
          id="series"
          formControlName="series"
          class="form-control"
          min="0"
        />
      </div>

      <div class="form-group col">
        <label for="repetitionsPerSeries">Repeticiones por Serie</label>
        <input
          type="number"
          id="repetitionsPerSeries"
          formControlName="repetitionsPerSeries"
          class="form-control"
          min="0"
        />
      </div>
    </div>

    <div class="form-group">
      <div class="radio-options">
        <label class="radio-label">
          <input
            type="radio"
            [value]="false"
            formControlName="withCompanion"
            name="withCompanion"
          />
          Sin acompañamiento
        </label>
        <label class="radio-label">
          <input
            type="radio"
            [value]="true"
            formControlName="withCompanion"
            name="withCompanion"
          />
          Con acompañamiento
        </label>
      </div>
    </div>

    <div class="form-group">
      <label for="description">Descripción</label>
      <textarea
        id="description"
        formControlName="description"
        class="form-control"
        rows="3"
        placeholder="Describe el propósito y beneficios de este ejercicio"
      ></textarea>
    </div>

    <div class="form-actions">
      <fbutton
        label="Cancelar"
        size="md"
        icon="fa-solid fa-xmark"
        (onClick)="onCancel()"
      ></fbutton>
      <fbutton
        label="Guardar"
        size="md"
        icon="fa-solid fa-floppy-disk"
        (onClick)="saveExercise()"
      ></fbutton>
    </div>
  </form>
</div>
